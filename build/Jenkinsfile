pipeline
agent(label "ec2")
stages{
  stage("Setup Ansible") 
  step{
  echo "Testing has already been done for"
  sh "yum install ansible -y"
  echo "ansible installed"
  }

  stage("Setup Terraform" 
        step{
          script{
          echo "install terraform"
          sh "sh 'wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip'"
          sh "unzip terraform_1.6.0_linux_amd64.zip"
          sudo "mv terraform /usr/local/bin"
          }
        }
        stage("Create infra for prod"){
          step{
            echo "setup vpc , ec2 for k8s"
            sh "terraform -chdir=.deploy/terraformscripts init"
            sh "terraform -chdir=.deploy/terrformscripts apply --auto-approve"
            sh "sleep 30"
            sh "pwd"
            echo "The next step is ypically done so that Ansible can reference the list of infrastructure resources created by Terraform."
            sh "cp .deploy/terraformscripts/inventory ./deploy/playbooks/inventory"
            echo "infra running"
          }
        }
        stage ("setup ansible"){
          enviornment 
          {
            ANSIBLE_DIR = './deploy/playbboks'
          }
        steps{
          dir($ANSIBLE_DIR}{
            sh "chmod 400 key"
            sh "ansible-playbook rhel-common.yaml"
            sh "ansible-plauybook rhel-master.yaml"
          echo "config done"
          }
              }
              }
              stage("configure monitoring tool"{
                enviornment{
                  ANSIBLE_DIR = './deploy/playbooks'
                }steps
                {
                  dir"($ANSIBLE_DIR)"
                    
                      sh "ansible-playbook prometheus.yaml"
                }
              }
                    }
                       stage("Deploy the Webserver"){
            environment {
                ANSIBLE_DIR = './deploy/playbooks' // Adjust this to the directory containing your ansible.cfg
            }
            steps{
                dir("${ANSIBLE_DIR}") {
                sh "ansible-playbook deployDeployment.yml"
            }
            }
        }
        
          
        
